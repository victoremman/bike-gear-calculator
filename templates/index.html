<!DOCTYPE html>
<html>
<head>
    <title>Calculadora de Marchas Inteligente</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .gps-status { padding: 10px; margin: 10px; border-radius: 5px; }
        .gps-active { background: #d4edda; border: 1px solid #c3e6cb; }
        .gps-inactive { background: #fff3cd; border: 1px solid #ffeeba; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h2 class="mb-4">Calculadora de Marchas</h2>

        <!-- Modo Manual -->
        <div id="manual-mode">
            <form method="POST">
                <div class="mb-3">
                    <label class="form-label">Velocidade (km/h)</label>
                    <input type="number" step="0.1" class="form-control" name="velocidade" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">Aro (polegadas)</label>
                    <input type="number" class="form-control" name="aro" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">Cadência (RPM)</label>
                    <input type="number" step="0.1" class="form-control" name="cadencia" required>
                </div>

                <button type="submit" class="btn btn-primary">Calcular Manualmente</button>
            </form>
        </div>

        <!-- Modo Automático -->
        <div class="mt-5">
            <h4>Modo Automático com GPS</h4>
            <div class="gps-status gps-inactive" id="gpsStatus">
                Status GPS: Não conectado
            </div>

            <form id="autoForm">
                <div class="mb-3">
                    <label class="form-label">Aro (polegadas)</label>
                    <input type="number" class="form-control" id="autoAro" required>
                </div>

                <button type="button" class="btn btn-success" onclick="startGPS()">
                    Iniciar Monitoramento GPS
                </button>
            </form>

            <div id="autoResult" class="mt-3"></div>
        </div>

        <!-- Resultados -->
        {% if resultado %}
        <div class="mt-4 alert alert-success">
            <h4>Resultado:</h4>
            <p>Marcha Ideal: {{ resultado.melhor_marcha }}</p>
            <p>Velocidade Estimada: {{ resultado.velocidade_atingida }}</p>
        </div>
        {% endif %}

        {% if erro %}
        <div class="mt-4 alert alert-danger">
            {{ erro }}
        </div>
        {% endif %}
    </div>

    <script>
        let watchId = null;

        function updateGPSStatus(active) {
            const statusDiv = document.getElementById('gpsStatus');
            statusDiv.className = `gps-status ${active ? 'gps-active' : 'gps-inactive'}`;
            statusDiv.textContent = `Status GPS: ${active ? 'Ativo' : 'Inativo'}`;
        }

        function handlePosition(position) {
            const data = {
                lat: position.coords.latitude,
                lon: position.coords.longitude,
                speed: position.coords.speed || 0,
                timestamp: Date.now()
            };

            fetch('/auto', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    aro: document.getElementById('autoAro').value,
                    ...data
                })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('autoResult').innerHTML = `
                    <div class="alert alert-info">
                        <p>Marcha Recomendada: ${data.marcha}</p>
                        <p>Velocidade Atual: ${(data.velocidade_atingida || '0.0').split(' ')[0]} km/h</p>
                    </div>
                `;
            });
        }

        function startGPS() {
            if (!navigator.geolocation) {
                alert("GPS não suportado neste navegador");
                return;
            }

            watchId = navigator.geolocation.watchPosition(
                position => {
                    updateGPSStatus(true);
                    handlePosition(position);
                },
                error => {
                    updateGPSStatus(false);
                    console.error('Erro GPS:', error);
                },
                {
                    enableHighAccuracy: true,
                    maximumAge: 3000,
                    timeout: 5000
                }
            );
        }
    </script>
</body>
</html>
